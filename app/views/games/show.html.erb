<script>

$( function() {
  $( ".piece" ).draggable({
    snap: ".piece-square",
    grid: [60, 60],
    containment: ".game-board",
  });

    
  $( ".piece-square" ).droppable({
    accept: ".piece",
    drop: function( event, ui ) {
      var x = $(event.target).data('x');
      var y = $(event.target).data('y');
      var urlUpdatePath = $('.ui-draggable-dragging').data('url');
      console.log(x);
      console.log(y);
      console.log(urlUpdatePath);
      
      var sendAJAXRequest = function(x, y, promo_choice) {  
      $.ajax({
        type: 'PUT',
        url: urlUpdatePath,
        data: { 
          piece: { x_position: x, y_position: y }
          promo_choice: promo_choice
        },
        success: function(response) {
          if(response == 'OK') {
            console.log(response);
          } else {
            alert(response);
          }
        }
      });
    };

  if (is_pawn_promotion()) {
  // code to display a modal with a choice of knight bishop rook or queen
  var promotionButtons = $('...') // this should be a jQuery selection of the buttons that would be clicked on in the modal
  promotionButtons.on('click', function() {
    sendAJAXRequest(x, y, promo_choice);
  });
  } else {
    sendAJAXRequest(x, y);
  }

  }); 
});

</script>

<div class="game-board-container">
  <h2 class="game-title"><%= @game.name %></h2>

  <table class="game-board">
    <% 7.downto(0) do |row| %>
      <tr>
        <% 0.upto(7) do |col| %>

          <td class="piece-square ui-droppable" data-x="<%= col %>" data-y="<%= row %>">
            <% @pieces.each do |piece| %>
              <% if piece.x_position == col && piece.y_position == row %>
                <div class="piece" data-url="<%= game_piece_path(piece.game, piece) %>">
                  <%= image_tag(piece.piece_image) %>
                </div>
              <% end %>
            <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </table>
</div>

<%= render 'partials/promotion_modal' %>



